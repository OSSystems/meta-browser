From 44d218fc74aa1c1477009ede7c81ea1cbfdbd45a Mon Sep 17 00:00:00 2001
From: Martin Jansa <Martin.Jansa@gmail.com>
Date: Thu, 28 May 2020 06:09:21 +0200
Subject: [PATCH] mozbuild: fix parallel build

 # HG changeset patch
 # User Mike Hommey <mh+mozilla@glandium.org>
 # Date 1561585440 0
 # Node ID e6330889fc03ce1fa8b839a0fe5833fbc964d1a0
 # Parent  7e48beac47cd831dd38d63e461163eb87ddc8c03

Bug 1500436 - Redirect node.js's stderr to a pipe. r=froydnj a=RyanVM

This works around https://github.com/nodejs/node/issues/14752, which
causes problems with make.

Differential Revision: https://phabricator.services.mozilla.com/D35986

Upstream-Status: Backport [https://hg.mozilla.org/releases/mozilla-esr68/rev/e6330889fc03]

Signed-off-by: Martin Jansa <Martin.Jansa@gmail.com>
---
 python/mozbuild/mozbuild/action/node.py | 15 +++++++++++++--
 1 file changed, 13 insertions(+), 2 deletions(-)

diff --git a/python/mozbuild/mozbuild/action/node.py b/python/mozbuild/mozbuild/action/node.py
index de4e094a94..73f13ac485 100644
--- a/python/mozbuild/mozbuild/action/node.py
+++ b/python/mozbuild/mozbuild/action/node.py
@@ -52,14 +52,25 @@ def execute_node_cmd(node_cmd_list):
         print('Executing "{}"'.format(printable_cmd), file=sys.stderr)
         sys.stderr.flush()
 
-        output = subprocess.check_output(node_cmd_list)
+        # We need to redirect stderr to a pipe because
+        # https://github.com/nodejs/node/issues/14752 causes issues with make.
+        proc = subprocess.Popen(
+            node_cmd_list, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
+
+        stdout, stderr = proc.communicate()
+        retcode = proc.wait()
+
+        if retcode != 0:
+            print(stderr, file=sys.stderr)
+            sys.stderr.flush()
+            sys.exit(retcode)
 
         # Process the node script output
         #
         # XXX Starting with an empty list means that node scripts can
         # (intentionally or inadvertently) remove deps.  Do we want this?
         deps = []
-        for line in output.splitlines():
+        for line in stdout.splitlines():
             if 'dep:' in line:
                 deps.append(line.replace('dep:', ''))
             else:
-- 
2.25.1

